{% extends "admin/index.html" %}

{% block content %}

    <!-- –ë–ª–æ–∫ —Ñ–æ—Ä–º—ã -->
    <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 6px; background: #f9f9f9;">
        <div style="display: flex; align-items: center; gap: 10px;">

            <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —á–∏—Å–ª–∞ -->
            <input id="ajax-value"
                   type="number"
                   min="1"
                   max="1000"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ"
                   style="width: 150px; padding: 6px 8px; border: 1px solid #bbb; border-radius: 4px;">

            <!-- –ö–Ω–æ–ø–∫–∞ -->
            <button id="ajax-button"
                    class="button"
                    style="padding: 8px 16px;">
                üöÄ –í—ã–ø–æ–ª–Ω–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- –°—Ç—Ä–æ–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è -->
    <div id="status-box"
         style="margin-bottom: 20px; padding: 10px; background: #eef5ff; border-left: 4px solid #417690;">
        <p id="status-text" style="margin: 0; color: #2a3f54;"></p>
    </div>

    {{ block.super }}

    <!-- JavaScript -->
    <script>
        const button = document.getElementById("ajax-button");
        const input = document.getElementById("ajax-value");
        const statusBox = document.getElementById("status-box");
        const statusText = document.getElementById("status-text");

        function updateStatus(txt) {
            statusText.innerText = txt;
            statusBox.style.display = "block";
        }

        button.addEventListener("click", async () => {
            const value = input.value;

            if (!value || value < 1 || value > 1000) {
                updateStatus("–û—à–∏–±–∫–∞: –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 1000");
                return;
            }

            updateStatus("–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...");

            try {
                const response = await fetch("{% url 'admin_custom_global_action' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                    body: JSON.stringify({value: value})
                });

                if (!response.ok) {
                    updateStatus("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + response.status);
                    return;
                }

                // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Ç–æ–∫–æ–≤—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const {value, done} = await reader.read();
                    if (done) break;
                    updateStatus(decoder.decode(value));
                }

            } catch (error) {
                updateStatus("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
            }
        });
    </script>

{% endblock %}